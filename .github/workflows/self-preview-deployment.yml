name: Self Preview Deployment

on:
  push:

jobs:
  get_version:
    runs-on: ubuntu-latest
    name: App Version Extraction
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      major_version: ${{ steps.get_version.outputs.major_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: |
          VERSION=$(grep "versionName" ./android/app/build.gradle | sed -E 's/.*versionName "([^"]+)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: Failed to extract version from build.gradle"
            exit 1
          fi
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
          if [ -z "$MAJOR_VERSION" ]; then
            echo "Error: Failed to extract major version from $VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "major_version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
          echo "Version extracted: $VERSION"
          echo "Major version extracted: $MAJOR_VERSION"

      - name: Print Version
        run: |
          echo "Version: ${{ steps.get_version.outputs.version }}"
          echo "Major Version: ${{ steps.get_version.outputs.major_version }}"

  android_preview_deployment:
    needs: get_version
    if: ${{ needs.get_version.result == 'success' }}
    name: Android Preview Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Targeted Clean for JS Bundler Cache
        run: |
          echo "--- Starting targeted clean ---"
          echo "Clearing global Metro cache to prevent JS contamination..."
          rm -rf /tmp/metro-*
          echo "--- Clean finished ---"
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install dependencies
        run: npm install

      - name: Create .env file
        run: echo "REACT_NATIVE_SERVER_URL=${{ secrets.REACT_NATIVE_SERVER_URL }}" > .env

      - name: Setup Revopush CLI
        uses: 'revopush/revopush-github-action@v1.0.0'
        id: setup-revopush-cli
        with:
          version: 'latest'
          accessKey: ${{ secrets.GH_REVOPUSH_ACCESS_KEY }}

      - name: Determine deployment name
        id: set-deployment-name
        run: |
          branch_name=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
          if [ "$branch_name" == "main" ]; then
            deployment_name="Production"
          elif [ "$branch_name" == "staging" ]; then
            deployment_name="Staging"
          else
            deployment_name=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9_-]//g')
          fi
          echo "deployment_name=$deployment_name" >> $GITHUB_ENV

      - name: Create deployment on Revopush
        run: |
          set +e
          revopush deployment add \
            SelfPreviewAndroid \
            ${{ env.deployment_name }} -k --format json || true

      - name: Create Raw JS Bundle
        run: |
          echo "Creating output directory for bundle..."
          mkdir -p ./android-assets
          echo "Creating raw JavaScript bundle..."
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output ./android-assets/index.android.bundle \
            --assets-dest ./android-assets

      - name: Compile Bundle into Hermes Bytecode
        run: |
          echo "Compiling bundle with Hermes..."
          HERMESC_PATH="./node_modules/react-native/sdks/hermesc/linux64-bin/hermesc"
          if [ ! -f "$HERMESC_PATH" ]; then
            echo "Linux Hermes compiler not found at path: $HERMESC_PATH"
            exit 1
          fi
          echo "Found Hermes Compiler at: $HERMESC_PATH"
          $HERMESC_PATH -emit-binary -out=./android-assets/index.android.bundle ./android-assets/index.android.bundle
          echo "Hermes compilation successful."

      - name: Prepare version range for Revopush
        id: version_range
        run: |
          MAJOR_VERSION="${{ needs.get_version.outputs.major_version }}"
          if [ -z "$MAJOR_VERSION" ]; then
            echo "Error: Major version is empty. Cannot construct version range."
            exit 1
          fi
          VERSION_RANGE=">=${MAJOR_VERSION}.0.0 <${MAJOR_VERSION}.1000.0"
          echo "version_range=$VERSION_RANGE" >> $GITHUB_OUTPUT
          echo "Version range: $VERSION_RANGE"

      - name: Deploy Android OTA to Revopush
        run: |
          revopush release \
            SelfPreviewAndroid \
            ./android-assets \
            "${{ steps.version_range.outputs.version_range }}" \
            -d ${{ env.deployment_name }} \
            --description "Preview deployment from branch ${{ github.ref_name }} (commit ${{ github.sha }})"

  ios_preview_deployment:
    needs: get_version
    if: ${{ needs.get_version.result == 'success' }}
    name: iOS Preview Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Targeted Clean for JS Bundler Cache
        run: |
          echo "--- Starting targeted clean ---"
          echo "Clearing global Metro cache to prevent JS contamination..."
          rm -rf /tmp/metro-*
          echo "--- Clean finished ---"
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install dependencies
        run: npm install

      - name: Create .env file
        run: echo "REACT_NATIVE_SERVER_URL=${{ secrets.REACT_NATIVE_SERVER_URL }}" > .env

      - name: Setup Revopush CLI
        uses: 'revopush/revopush-github-action@v1.0.0'
        id: setup-revopush-cli
        with:
          version: 'latest'
          accessKey: ${{ secrets.GH_REVOPUSH_ACCESS_KEY }}

      - name: Determine deployment name
        id: set-deployment-name
        run: |
          branch_name=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
          if [ "$branch_name" == "main" ]; then
            deployment_name="Production"
          elif [ "$branch_name" == "staging" ]; then
            deployment_name="Staging"
          else
            deployment_name=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9_-]//g')
          fi
          echo "deployment_name=$deployment_name" >> $GITHUB_ENV

      - name: Create deployment on Revopush
        run: |
          set +e
          revopush deployment add \
            SelfPreviewIOS \
            ${{ env.deployment_name }} -k --format json || true

      - name: Create Raw JS Bundle for iOS
        run: |
          echo "Creating output directory for iOS bundle..."
          mkdir -p ./ios-assets
          echo "Creating raw JavaScript bundle for iOS..."
          npx react-native bundle \
            --platform ios \
            --dev false \
            --entry-file index.js \
            --bundle-output ./ios-assets/main.jsbundle \
            --assets-dest ./ios-assets

      - name: Compile Bundle into Hermes Bytecode for iOS
        run: |
          echo "Compiling bundle with Hermes for iOS..."
          HERMESC_PATH="./node_modules/react-native/sdks/hermesc/linux64-bin/hermesc"
          if [ ! -f "$HERMESC_PATH" ]; then
            echo "Linux Hermes compiler not found at path: $HERMESC_PATH"
            exit 1
          fi
          echo "Found Hermes Compiler at: $HERMESC_PATH"
          $HERMESC_PATH -emit-binary -out=./ios-assets/main.jsbundle ./ios-assets/main.jsbundle
          echo "Hermes compilation for iOS successful."

      - name: Prepare version range for Revopush (iOS)
        id: version_range_ios
        run: |
          MAJOR_VERSION="${{ needs.get_version.outputs.major_version }}"
          if [ -z "$MAJOR_VERSION" ]; then
            echo "Error: Major version is empty. Cannot construct version range."
            exit 1
          fi
          VERSION_RANGE=">=${MAJOR_VERSION}.0.0 <${MAJOR_VERSION}.1000.0"
          echo "version_range=$VERSION_RANGE" >> $GITHUB_OUTPUT
          echo "Version range: $VERSION_RANGE"

      - name: Release Compiled Assets to Revopush for iOS
        run: |
          echo "Uploading compiled bundle and assets for iOS..."
          revopush release \
            SelfPreviewIOS \
            ./ios-assets \
            "${{ steps.version_range_ios.outputs.version_range }}" \
            -d ${{ env.deployment_name }} \
            --description "Preview deployment from branch ${{ github.ref_name }} (commit ${{ github.sha }})"
